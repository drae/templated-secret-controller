# Development Guide

This document describes how to develop and contribute to the templated-secret-controller project.

## Prerequisites

- Go 1.21+
- kubectl
- Docker
- Access to a Kubernetes cluster (for testing)

## Project Structure

```
templated-secret-controller/
├── cmd/                  # Application entry points
├── config/               # Kubernetes manifests and configuration
│   ├── kustomize/        # Kustomize-based deployment configs
│       ├── base/         # Base resources
│       └── overlays/     # Environment-specific overlays
├── docs/                 # Documentation
├── examples/             # Usage examples
├── hack/                 # Development scripts
└── pkg/                  # Core controller logic and API types
    ├── apis/             # API definitions
    │   └── templatedsecret/ # API group
    └── client/           # Generated client code
```

## Development Workflow

### Setting up your Environment

1. Clone the repository:

   ```shell
   git clone https://github.com/drae/templated-secret-controller.git
   cd templated-secret-controller
   ```

2. Install dependencies:

   ```shell
   go mod download
   ```

### Common Development Tasks

The project includes a development helper script at `hack/dev.sh` that provides shortcuts for common tasks:

```shell
# Build the controller
./hack/dev.sh build

This will also run fmt and vet

# Run tests
./hack/dev.sh test

# Generate CRD manifests
./hack/dev.sh manifests

# Run the controller locally (against your current kubeconfig cluster)
./hack/dev.sh run

# Build a Docker image
./hack/dev.sh docker

# Deploy development configuration to your cluster
./hack/dev.sh deploy-dev
```

You can also use the Makefile directly for more granular control:

```shell
# Build the controller
make build

# Run tests
make test

# Generate CRD manifests
make manifests

# Build and push a multi-architecture Docker image
make docker-push
```

## Testing

### Unit Tests

Run unit tests with:

```shell
make test
```

### End-to-End Tests

End-to-end tests are located in the `test/e2e` directory and can be executed with:

```shell
go test ./test/e2e -v
```

## Releasing

## Release

Release versions are scraped from git tags in the same style as the goreleaser
tool.

Tag the release - it's necessary to do this first because the release process uses the latest tag to record the version.

1. Tag a new version:

   ```shell
   git tag -a v0.1.0 -m "Release v0.1.0"
   git push origin v0.1.0
   ```

2. The GitHub Actions workflow will:
   - Build and test the code
   - Build multi-architecture container images (amd64, arm64)
   - Push images to GitHub Container Registry
   - Generate and attach Kubernetes manifests to the GitHub release

After the release process finishes successfully, you can view the newly drafted release via
the GitHub UI [here](https://github.com/carvel-dev/templated-secretsecret-controller/releases).

The newly published release will be available as a Draft (i.e. not available to the public).
Release notes can be autogenerated by GitHub, but make sure to call attention to any points
that are not immediately clear from the autogenerated notes. Make sure to always thank external
contributors for their additions to kapp-controller in the release notes.

Once the release notes are ready, clicking the `Publish release` button in the GitHub UI to
make the release available to users.

Releases are handled through GitHub Actions when a git tag is pushed:

## Code Conventions

This project follows standard Go conventions:

- Code should be formatted with `gofmt`
- Follow standard Go naming conventions
- Write tests for new functionality
- Update documentation for user-facing changes
